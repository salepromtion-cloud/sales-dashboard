<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Sales Dashboard — Manager Enabled</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <!-- Firebase v8 -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

  <style>
    :root{
      --bg:#f4f8ff; --primary:#0f3b82; --accent:#2563eb; --muted:#6b7280;
      --card:#ffffff; --radius:12px; --shadow:0 10px 30px rgba(16,24,40,0.06);
      font-family:Inter, "Segoe UI", Roboto, Arial, sans-serif;
    }
    body{margin:0;background:linear-gradient(180deg,#f7fbff,#eef6ff);color:#07123a;padding:18px}
    .container{max-width:1100px;margin:0 auto}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:18px}
    .brand {display:flex;align-items:center;gap:12px}
    .brand .title{font-size:20px;color:var(--primary);font-weight:700}
    .brand .subtitle{font-size:12px;color:var(--muted)}
    .top-right{display:flex;align-items:center;gap:10px}
    .btn{padding:8px 12px;border-radius:8px;border:none;cursor:pointer}
    .btn-primary{background:var(--primary);color:#fff}
    .btn-outline{background:#fff;border:1px solid rgba(15,59,130,0.12);color:var(--primary)}
    .grid{display:grid;grid-template-columns:2fr 1fr;gap:16px}
    .card{background:var(--card);border-radius:var(--radius);padding:14px;box-shadow:var(--shadow)}
    .section-title{font-weight:700;color:var(--primary);margin-bottom:10px}
    .kpi{display:flex;gap:12px;flex-wrap:wrap}
    .tile{flex:1;min-width:140px;background:#fff;border-radius:10px;padding:12px;border:1px solid #eef3ff;text-align:center}
    .tile h4{margin:0;font-size:12px;color:var(--muted)}
    .tile p{margin:6px 0 0;font-size:18px;font-weight:800}
    .row-flex{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:14px}
    .half{flex:1;min-width:150px}
    .small-box{background:#fff;border-radius:10px;padding:12px;border:1px solid #eef3ff;text-align:center}
    .small-box .title{font-weight:800;color:var(--primary);font-size:13px}
    .small-box .subtitle{font-size:12px;color:var(--muted);margin-bottom:6px}
    .small-box .value{font-weight:800;font-size:20px}
    .progress-wrap{background:#f1f5f9;border-radius:10px;padding:12px;border:1px solid #eef3ff}
    .progress-bar{height:18px;background:#e9eef5;border-radius:12px;overflow:hidden}
    .progress-bar-inner{height:100%;background:linear-gradient(90deg,var(--accent),#14a0d6);width:0%;border-radius:12px;transition:width 600ms ease}
    .rank-box{background:linear-gradient(180deg,#1f3f7a,#17335e);color:#fff;padding:16px;border-radius:12px;text-align:center;margin-bottom:12px}
    .trend-box{background:#fff;border-radius:10px;padding:12px;border:1px solid #eef3ff;margin-bottom:12px}
    .return-box-title{font-weight:700;color:#b91c1c}
    .return-value{font-weight:700;color:#b91c1c;font-size:18px}
    .return-percent{font-weight:700;color:#b91c1c;font-size:18px}
    select#managerSelect{padding:8px;border-radius:8px;border:1px solid #d1d5db;background:#fff}
    .logo-img{height:40px;object-fit:contain;border-radius:6px}
    @media (max-width:980px){ .grid{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="brand">
        <!-- if you want to use logo, it's included here using the developer-provided path -->
        <img src="/mnt/data/Aushad Logo.pdf" alt="Company Logo" class="logo-img" onerror="this.style.display='none'">
        <div>
          <div class="title">Your Sales Performance Report</div>
          <div class="subtitle">Live sales view — secure login</div>
        </div>
      </div>

      <div class="top-right">
        <div id="userInfo" style="color:var(--muted)">Please login</div>
        <select id="managerSelect" style="display:none">
          <option value="">Select Salesman</option>
        </select>
        <button id="loginBtn" class="btn btn-primary">Login with Google</button>
        <button id="logoutBtn" class="btn btn-outline" style="display:none">Logout</button>
      </div>
    </header>

    <main class="grid">
      <div class="card">
        <div class="section-title">Pharma Performance</div>
        <div class="kpi" style="margin-bottom:12px">
          <div class="tile"><h4>Target Pharma</h4><p id="targetPharma">-</p></div>
          <div class="tile"><h4>Achieved Pharma</h4><p id="pharmaSales">-</p></div>
          <div class="tile"><h4>Pending Pharma</h4><p id="pendingPharma">-</p></div>
          <div class="tile"><h4>Pharma %</h4><p id="achievedPharmaPercent">-</p></div>
        </div>

        <div class="section-title">Pharma Run Rate</div>
        <div class="row-flex">
          <div class="half small-box"><div class="title">Daily Pharma Average (CRR)</div><div class="subtitle">(CRR) / day</div><div class="value" id="pharmaCRR">-</div></div>
          <div class="half small-box"><div class="title">Daily Pharma Needed (RRR)</div><div class="subtitle">(RRR) / day</div><div class="value" id="pharmaRRR">-</div></div>
        </div>

        <div class="section-title">PL Performance</div>
        <div class="kpi" style="margin-bottom:12px">
          <div class="tile"><h4>Target PL</h4><p id="targetPL">-</p></div>
          <div class="tile"><h4>Achieved PL</h4><p id="plSales">-</p></div>
          <div class="tile"><h4>Pending PL</h4><p id="pendingPL">-</p></div>
          <div class="tile"><h4>PL %</h4><p id="achievedPLPercent">-</p></div>
        </div>

        <div class="section-title">PL Run Rate</div>
        <div class="row-flex">
          <div class="half small-box"><div class="title">Daily PL Average (CRR)</div><div class="subtitle">(CRR) / day</div><div class="value" id="plCRR">-</div></div>
          <div class="half small-box"><div class="title">Daily PL Needed (RRR)</div><div class="subtitle">(RRR) / day</div><div class="value" id="plRRR">-</div></div>
        </div>

        <div class="section-title">Performance Progress</div>
        <div class="progress-wrap">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
            <div style="font-weight:700;color:var(--primary)">Pharma</div>
            <div id="pharmaProgressPct" style="font-weight:800">-</div>
          </div>
          <div class="progress-bar"><div id="pharmaProgressInner" class="progress-bar-inner"></div></div>
          <div class="progress-small" id="pharmaProgressText">-</div>
        </div>

        <div class="progress-wrap" style="margin-top:12px">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
            <div style="font-weight:700;color:var(--primary)">PL</div>
            <div id="plProgressPct" style="font-weight:800">-</div>
          </div>
          <div class="progress-bar"><div id="plProgressInner" class="progress-bar-inner"></div></div>
          <div class="progress-small" id="plProgressText">-</div>
        </div>
      </div>

      <div class="card">
        <div class="section-title">Rank</div>
        <div class="rank-box">
          <div style="font-size:13px;opacity:0.95">Your Rank</div>
          <div id="rankValue" style="font-size:34px;font-weight:800;margin-top:6px">-</div>
          <div style="font-size:12px;margin-top:6px;opacity:0.9">based on (Pharma % + PL %)</div>
        </div>

        <div class="trend-box">
          <div style="font-weight:700;color:var(--primary)">Pharma Projection</div>
          <div style="display:flex;justify-content:space-between;margin-top:10px">
            <div><div style="font-size:12px;color:var(--muted)">CRR</div><div id="trend_pharma_crr" style="font-weight:700">-</div></div>
            <div><div style="font-size:12px;color:var(--muted)">Projected</div><div id="trend_pharma_projected" style="font-weight:700">-</div></div>
            <div><div style="font-size:12px;color:var(--muted)">Gap</div><div id="trend_pharma_gap" style="font-weight:700">-</div></div>
          </div>
        </div>

        <div class="trend-box">
          <div style="font-weight:700;color:var(--primary)">PL Projection</div>
          <div style="display:flex;justify-content:space-between;margin-top:10px">
            <div><div style="font-size:12px;color:var(--muted)">CRR</div><div id="trend_pl_crr" style="font-weight:700">-</div></div>
            <div><div style="font-size:12px;color:var(--muted)">Projected</div><div id="trend_pl_projected" style="font-weight:700">-</div></div>
            <div><div style="font-size:12px;color:var(--muted)">Gap</div><div id="trend_pl_gap" style="font-weight:700">-</div></div>
          </div>
        </div>

        <div class="trend-box">
          <div class="return-box-title">Pharma Return</div>
          <div style="display:flex;justify-content:space-between;margin-top:10px">
            <div><div style="font-size:12px;color:var(--muted)">Return</div><div class="return-value" id="pharma_return">-</div></div>
            <div><div style="font-size:12px;color:var(--muted)">Return %</div><div class="return-percent" id="pharma_return_percent">-</div></div>
          </div>
        </div>

        <div class="trend-box">
          <div class="return-box-title">PL Return</div>
          <div style="display:flex;justify-content:space-between;margin-top:10px">
            <div><div style="font-size:12px;color:var(--muted)">Return</div><div class="return-value" id="pl_return">-</div></div>
            <div><div style="font-size:12px;color:var(--muted)">Return %</div><div class="return-percent" id="pl_return_percent">-</div></div>
          </div>
        </div>

      </div>
    </main>
  </div>

<script>
/* ======= Config ======= */
const MANAGERS = [
  "jinesh.jain@apdpl.in",
  "vmamys@gmail.com",
  "harishdarera@gmail.com",
  "cvjain1@gmail.com",
  "aravindan.s@apdpl.in"
];

/* If you redeploy apps script change this URL */
const API_URL = "https://script.google.com/macros/s/AKfycbwHPdcB4MLaKu3VUDNfpkpiWEvnz3nRhwbbna0-5dn0dlO-ICf6913k8n9yMScc3fO8/exec";

/* Firebase config */
const firebaseConfig = {
  apiKey: "AIzaSyAtdeN84prygknfyF-aZ7d6Wr0m2LYSFek",
  authDomain: "salesdashboard-8a33e.firebaseapp.com",
  projectId: "salesdashboard-8a33e",
  storageBucket: "salesdashboard-8a33e.firebasestorage.app",
  messagingSenderId: "939228252310",
  appId: "1:939228252310:web:c847ef8b0afc92e7495ab7"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();

/* ======= Helpers ======= */
function safeNum(v){ if(v===undefined||v===null||v==="") return 0; v=(v+"").replace(/,/g,"").trim(); return Number(v)||0; }
function fmtMoney(n){ return new Intl.NumberFormat("en-IN").format(Math.round(n)); }
function countWorkingDaysTillToday(){ const today=new Date(); const y=today.getFullYear(), m=today.getMonth(), d=today.getDate(); let wd=0; for(let i=1;i<=d;i++){ const dt=new Date(y,m,i); if(dt.getDay()!==0) wd++; } return Math.max(1,wd); }
function countRemainingWorkingDays(){ const today=new Date(); const y=today.getFullYear(), m=today.getMonth(); const last=new Date(y,m+1,0).getDate(); let rem=0; for(let i=today.getDate()+1;i<=last;i++){ const dt=new Date(y,m,i); if(dt.getDay()!==0) rem++; } return rem; }
function countWorkingDaysTotal(){ const today=new Date(); const y=today.getFullYear(), m=today.getMonth(); const last=new Date(y,m+1,0).getDate(); let total=0; for(let i=1;i<=last;i++){ const dt=new Date(y,m,i); if(dt.getDay()!==0) total++; } return Math.max(1,total); }

/* ======= Auth & manager logic ======= */
auth.onAuthStateChanged(async user=>{
  if(user){
    document.getElementById("loginBtn").style.display="none";
    document.getElementById("logoutBtn").style.display="inline-block";
    document.getElementById("userInfo").textContent = user.displayName || user.email || "User";
    const email = (user.email||"").toLowerCase().trim();

    // if manager - show dropdown and populate list (only names)
    if(MANAGERS.map(m=>m.toLowerCase().trim()).includes(email)){
      document.getElementById("managerSelect").style.display = "inline-block";
      await populateManagerDropdown(); // will show names
    } else {
      document.getElementById("managerSelect").style.display = "none";
      loadDataForUser(user.email);
    }
  } else {
    document.getElementById("loginBtn").style.display="inline-block";
    document.getElementById("logoutBtn").style.display="none";
    document.getElementById("userInfo").textContent = "Please login";
    document.getElementById("managerSelect").style.display = "none";
  }
});

document.getElementById("loginBtn").onclick = ()=> { const provider = new firebase.auth.GoogleAuthProvider(); auth.signInWithPopup(provider).catch(e=>console.error(e)); };
document.getElementById("logoutBtn").onclick = ()=> auth.signOut();

/* Populate manager dropdown (names only) */
async function populateManagerDropdown(){
  try {
    const res = await fetch(API_URL + "?all=true");
    const rows = await res.json();
    const sel = document.getElementById("managerSelect");
    sel.innerHTML = '<option value="">Select Salesman</option>';
    // build a mapping name -> email (may be empty)
    window._nameEmailMap = {};
    // show all rows sorted by salesmanName (case-insensitive)
    rows.sort((a,b)=>{
      const A = (a.salesmanName||a.salesman||"").toString().toLowerCase();
      const B = (b.salesmanName||b.salesman||"").toString().toLowerCase();
      return A.localeCompare(B);
    });
    rows.forEach(r=>{
      const name = (r.salesmanName || r.salesman || r.salesmanname || "").toString().trim();
      if(!name) return; // skip empty names
      const email = (r.email || "").toString().toLowerCase().trim();
      // prevent duplicates: if same name repeats, append index
      let optionText = name;
      let idx = 1;
      while (Array.from(sel.options).some(o => o.text === optionText)) {
        idx++;
        optionText = name + " ("+idx+")";
      }
      const opt = document.createElement("option");
      opt.value = name;
      opt.textContent = optionText;
      sel.appendChild(opt);
      // store mapping
      if(!window._nameEmailMap[name]) window._nameEmailMap[name] = email; // keep first email if multiple
    });
    sel.onchange = function(){
      const selName = this.value;
      if(!selName) return;
      const mappedEmail = (window._nameEmailMap && window._nameEmailMap[selName]) || "";
      if(mappedEmail) {
        loadDataForUser(mappedEmail);
      } else {
        // fallback to name-based query
        loadDataForUserByName(selName);
      }
    };
  } catch(err){
    console.error("populateManagerDropdown error", err);
  }
}

/* load by name (calls ?name=...) */
async function loadDataForUserByName(name){
  try {
    const res = await fetch(API_URL + "?name=" + encodeURIComponent(name));
    const data = await res.json();
    if(!data || !data.length){ alert("No sales data for '" + name + "'"); return; }
    populateDashboardFromRow(data[0]);
  } catch(e){
    console.error("loadDataForUserByName error", e);
    alert("Unable to load data for " + name);
  }
}

/* main loader by email */
async function loadDataForUser(email){
  if(!email) return;
  try {
    const res = await fetch(API_URL + "?email=" + encodeURIComponent(email));
    const data = await res.json();
    if(!data || !data.length){
      // if no data by email, try name match (maybe sheet has that email missing but name present)
      alert("No sales row for this email: " + email);
      return;
    }
    populateDashboardFromRow(data[0]);
  } catch(err){
    console.error("loadDataForUser error", err);
    alert("Unable to load data for " + email);
  }
}

/* Fill the UI from a sheet row object */
function populateDashboardFromRow(row){
  const tPh = safeNum(row.targetPharma), aPh = safeNum(row.pharmaSales), pPh = safeNum(row.pendingPharma);
  const tPl = safeNum(row.targetPL), aPl = safeNum(row.plSales), pPl = safeNum(row.pendingPL);

  document.getElementById("targetPharma").textContent = fmtMoney(tPh);
  document.getElementById("pharmaSales").textContent = fmtMoney(aPh);
  document.getElementById("pendingPharma").textContent = fmtMoney(pPh);

  const phPctVal = Number(String(row.achievedPharmaPercent).replace(/,/g,''))||0;
  document.getElementById("achievedPharmaPercent").textContent = Math.round(phPctVal) + "%";

  document.getElementById("targetPL").textContent = fmtMoney(tPl);
  document.getElementById("plSales").textContent = fmtMoney(aPl);
  document.getElementById("pendingPL").textContent = fmtMoney(pPl);

  const plPctVal = Number(String(row.achievedPLPercent).replace(/,/g,''))||0;
  document.getElementById("achievedPLPercent").textContent = Math.round(plPctVal) + "%";

  const Wpassed = countWorkingDaysTillToday(), Wrem = countRemainingWorkingDays(), Wtotal = countWorkingDaysTotal();

  const phCRR = Math.round(aPh / Math.max(1,Wpassed));
  document.getElementById("pharmaCRR").textContent = phCRR===0? "-" : fmtMoney(phCRR);
  const phRRR = Wrem>0 ? Math.ceil(Math.max(0,tPh-aPh)/Wrem) : Math.max(0,tPh - aPh);
  document.getElementById("pharmaRRR").textContent = fmtMoney(phRRR);

  const plCRR = Math.round(aPl / Math.max(1,Wpassed));
  document.getElementById("plCRR").textContent = plCRR===0? "-" : fmtMoney(plCRR);
  const plRRR = Wrem>0 ? Math.ceil(Math.max(0,tPl-aPl)/Wrem) : Math.max(0,tPl - aPl);
  document.getElementById("plRRR").textContent = fmtMoney(plRRR);

  const phProjected = Math.round(phCRR * Wtotal), phGap = Math.max(0, tPh - phProjected);
  document.getElementById("trend_pharma_crr").textContent = phCRR===0? "-" : fmtMoney(phCRR);
  document.getElementById("trend_pharma_projected").textContent = fmtMoney(phProjected);
  document.getElementById("trend_pharma_gap").textContent = fmtMoney(phGap);

  const plProjected = Math.round(plCRR * Wtotal), plGap = Math.max(0, tPl - plProjected);
  document.getElementById("trend_pl_crr").textContent = plCRR===0? "-" : fmtMoney(plCRR);
  document.getElementById("trend_pl_projected").textContent = fmtMoney(plProjected);
  document.getElementById("trend_pl_gap").textContent = fmtMoney(plGap);

  const phPct = tPh === 0 ? 0 : Math.min(100, Math.round((aPh/tPh)*100));
  const plPct = tPl === 0 ? 0 : Math.min(100, Math.round((aPl/tPl)*100));

  document.getElementById("pharmaProgressInner").style.width = phPct + "%";
  document.getElementById("pharmaProgressPct").textContent = phPct + "%";
  document.getElementById("pharmaProgressText").textContent = fmtMoney(aPh) + " / " + fmtMoney(tPh);

  document.getElementById("plProgressInner").style.width = plPct + "%";
  document.getElementById("plProgressPct").textContent = plPct + "%";
  document.getElementById("plProgressText").textContent = fmtMoney(aPl) + " / " + fmtMoney(tPl);

  // returns
  const pharmaReturn = safeNum(row["Pharma Return"] || row.pharmaReturn || row.pharma_return);
  const plReturn = safeNum(row["PL Return"] || row.plReturn || row.pl_return);
  let phReturnPct = 0;
  if ((aPh + pharmaReturn) > 0) phReturnPct = Math.round((pharmaReturn / (aPh + pharmaReturn)) * 100);
  let plReturnPct = 0;
  if ((aPl + plReturn) > 0) plReturnPct = Math.round((plReturn / (aPl + plReturn)) * 100);

  document.getElementById("pharma_return").textContent = pharmaReturn? fmtMoney(pharmaReturn) : "-";
  document.getElementById("pharma_return_percent").textContent = phReturnPct + "%";
  document.getElementById("pl_return").textContent = plReturn? fmtMoney(plReturn) : "-";
  document.getElementById("pl_return_percent").textContent = plReturnPct + "%";

  // compute rank from all rows
  computeRank((row.email || "").toString().toLowerCase().trim());
}

/* compute rank */
async function computeRank(email){
  try {
    const res = await fetch(API_URL + "?all=true");
    const all = await res.json();
    if(!all || !all.length){ document.getElementById("rankValue").textContent="-"; return; }
    const scores = all.map(r=>{
      let p = Number(String(r.achievedPharmaPercent).replace(/,/g,''))||0;
      let l = Number(String(r.achievedPLPercent).replace(/,/g,''))||0;
      if(p>0 && p<=1) p *= 100;
      if(l>0 && l<=1) l *= 100;
      return { email:(r.email||"").toLowerCase().trim(), score: p + l };
    });
    scores.sort((a,b)=>b.score - a.score);
    const idx = scores.findIndex(s => s.email === (email||"").toLowerCase().trim());
    document.getElementById("rankValue").textContent = idx === -1 ? "-" : (idx+1);
  } catch(e){
    console.error("computeRank error", e);
    document.getElementById("rankValue").textContent = "-";
  }
}
</script>
</body>
</html>


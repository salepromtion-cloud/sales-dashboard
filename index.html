<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Sales Dashboard</title>

  <!-- Firebase v8 (Browser) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

  <!-- Google Charts -->
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <style>
    :root{
      --bg:#f6f7fb; --card:#ffffff;
      --accent:#f6c000; --accent-dark:#e0ad00;
      --green:#16a34a; --muted:#6b7280;
      --primary:#1e3a8a; --radius:12px;
    }
    body{font-family:Inter, Arial, sans-serif; margin:0; padding:18px; background:var(--bg); color:#0f172a;}
    .container{max-width:1100px; margin:0 auto;}
    header{display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:18px}
    h1{margin:0; font-size:26px; color:var(--primary)}
    .top-actions{display:flex; gap:10px}
    button.btn{background:var(--primary); color:#fff; border:none; padding:8px 12px; border-radius:8px; cursor:pointer}
    button.btn.secondary{background:#fff; color:var(--primary); border:1px solid #d1d5db}
    .profile{font-size:14px; color:var(--muted)}
    .grid{display:grid; grid-template-columns: repeat(12, 1fr); gap:14px;}
    .card{background:var(--card); border-radius:var(--radius); padding:14px; box-shadow:0 6px 18px rgba(15,23,42,0.06)}
    .section-title{font-weight:700; font-size:15px; color:var(--primary); margin-bottom:8px}
    .kpi {display:flex; gap:12px; align-items:center}
    .kpi .tile{flex:1; padding:12px; border-radius:10px; background:#ffffff; text-align:center; border:1px solid #e5e7eb}
    .kpi .tile h4{margin:0; font-size:12px; color:var(--muted)}
    .kpi .tile p{margin:6px 0 0; font-weight:700; font-size:17px}
    .left-col{grid-column:span 8}
    .right-col{grid-column:span 4}
    #chart_bar{width:100%; height:340px}
    .row-flex{display:flex; gap:10px; flex-wrap:wrap}
    .half{flex:1; min-width:130px}
    .small-box{padding:12px; border-radius:10px; border:1px solid #e5e7eb; background:#fff}
    .small-value{font-size:18px; font-weight:700}
    .label-muted{color:var(--muted); font-size:12px}
    .tile-top {font-size:12px; color:var(--muted); margin-bottom:6px;}
    .rank-box {background: linear-gradient(180deg,#6f2ea8,#5a1f89); color:#fff; padding:18px; border-radius:12px; text-align:center; box-shadow:0 8px 24px rgba(15,23,42,0.08)}
    .trend-box {padding:12px; border-radius:10px; border:1px solid #e5e7eb; background:#fff; margin-top:12px}
    .trend-title {font-size:13px; font-weight:700; color:var(--primary); margin-bottom:8px}
    .trend-value {font-size:18px; font-weight:700}
    .muted-small {font-size:12px; color:var(--muted)}
    @media (max-width:880px){
      .left-col{grid-column:span 12}
      .right-col{grid-column:span 12}
      #chart_bar{height:260px}
      header{flex-direction:column; align-items:flex-start}
    }
  </style>
</head>
<body>

  <div class="container">

    <!-- Top -->
    <header>
      <div>
        <h1>Your Sales Performance Report <span id="reportDate" style="font-size:13px;color:var(--muted)"></span></h1>
        <div id="userInfo" class="profile">Please login to view sales</div>
      </div>

      <div class="top-actions">
        <button id="loginBtn" class="btn">Login with Google</button>
        <button id="logoutBtn" class="btn secondary" style="display:none">Logout</button>
      </div>
    </header>

    <!-- GRID -->
    <div class="grid">

      <!-- LEFT -->
      <div class="card left-col">

        <div class="section-title">Pharma Performance</div>
        <div class="kpi" style="margin-bottom:12px">
          <div class="tile">
            <h4>Target Pharma</h4>
            <p id="targetPharma">-</p>
          </div>
          <div class="tile">
            <h4>Achieved Pharma</h4>
            <p id="pharmaSales">-</p>
          </div>
          <div class="tile">
            <h4>Pending Pharma</h4>
            <p id="pendingPharma">-</p>
          </div>
          <div class="tile">
            <h4>Pharma %</h4>
            <p id="achievedPharmaPercent">-</p>
          </div>
        </div>

        <!-- Pharma Run Rate Section -->
        <div class="section-title">Pharma Run Rate</div>
        <div class="row-flex" style="margin-bottom:12px">
          <div class="half small-box">
            <div class="tile-top">(CRR) / day</div>
            <div class="label-muted">Daily Pharma Average (CRR)</div>
            <div class="small-value" id="pharmaCRR">-</div>
          </div>
          <div class="half small-box">
            <div class="tile-top">(RRR) / day</div>
            <div class="label-muted">Daily Pharma Needed (RRR)</div>
            <div class="small-value" id="pharmaRRR">-</div>
          </div>
        </div>

        <!-- PL -->
        <div class="section-title">PL Performance</div>
        <div class="kpi" style="margin-bottom:12px">
          <div class="tile">
            <h4>Target PL</h4>
            <p id="targetPL">-</p>
          </div>
          <div class="tile">
            <h4>Achieved PL</h4>
            <p id="plSales">-</p>
          </div>
          <div class="tile">
            <h4>Pending PL</h4>
            <p id="pendingPL">-</p>
          </div>
          <div class="tile">
            <h4>PL %</h4>
            <p id="achievedPLPercent">-</p>
          </div>
        </div>

        <!-- PL Run Rate -->
        <div class="section-title">PL Run Rate</div>
        <div class="row-flex" style="margin-bottom:12px">
          <div class="half small-box">
            <div class="tile-top">(CRR) / day</div>
            <div class="label-muted">Daily PL Average (CRR)</div>
            <div class="small-value" id="plCRR">-</div>
          </div>
          <div class="half small-box">
            <div class="tile-top">(RRR) / day</div>
            <div class="label-muted">Daily PL Needed (RRR)</div>
            <div class="small-value" id="plRRR">-</div>
          </div>
        </div>

        <div class="section-title">Target vs Achievement</div>
        <div id="chart_bar"></div>
      </div>

      <!-- RIGHT -->
      <div class="card right-col">
        <div class="section-title">Rank & Trending</div>

        <div style="display:flex;gap:12px;align-items:center">
          <div style="flex:1">
            <div class="rank-box">
              <div style="font-size:14px;opacity:0.95">Your Rank</div>
              <div id="rankValue" style="font-size:34px;font-weight:800;margin-top:6px">-</div>
              <div style="font-size:12px;margin-top:6px;opacity:0.9">based on (Pharma % + PL %)</div>
            </div>
          </div>
        </div>

        <div class="trend-box">
          <div class="trend-title">Pharma Trending (Projection)</div>
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <div class="muted-small">CRR</div>
              <div class="trend-value" id="trend_pharma_crr">-</div>
            </div>
            <div>
              <div class="muted-small">Projected</div>
              <div class="trend-value" id="trend_pharma_projected">-</div>
            </div>
            <div>
              <div class="muted-small">Gap</div>
              <div class="trend-value" id="trend_pharma_gap">-</div>
            </div>
          </div>
        </div>

        <div class="trend-box">
          <div class="trend-title">PL Trending (Projection)</div>
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <div class="muted-small">CRR</div>
              <div class="trend-value" id="trend_pl_crr">-</div>
            </div>
            <div>
              <div class="muted-small">Projected</div>
              <div class="trend-value" id="trend_pl_projected">-</div>
            </div>
            <div>
              <div class="muted-small">Gap</div>
              <div class="trend-value" id="trend_pl_gap">-</div>
            </div>
          </div>
        </div>

      </div>

    </div>

  </div>

<!-- SCRIPT -->
<script>
/* Firebase */
const firebaseConfig = {
  apiKey: "AIzaSyAtdeN84prygknfyF-aZ7d6Wr0m2LYSFek",
  authDomain: "salesdashboard-8a33e.firebaseapp.com",
  projectId: "salesdashboard-8a33e",
  storageBucket: "salesdashboard-8a33e.firebasestorage.app",
  messagingSenderId: "939228252310",
  appId: "1:939228252310:web:c847ef8b0afc92e7495ab7"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();

document.getElementById("reportDate").textContent =
  new Date().toLocaleDateString("en-IN");

/* Helpers */
function safeNum(v){
  if (v === undefined || v === null || v === "") return 0;
  v = (v+"").replace(/,/g,"").trim();
  return Number(v) || 0;
}
function fmtMoney(n){
  return new Intl.NumberFormat("en-IN").format(n);
}
function fmtPercentValue(x){
  // if value is like 0.97 assume decimal, else if 97 assume already percent
  const num = Number(String(x).replace(/,/g,"")) || 0;
  if (num > 0 && num <= 1) {
    return Math.round(num * 100) + "%";
  } else {
    return Math.round(num) + "%";
  }
}

/* Working days helpers */
function countWorkingDaysTillToday() {
  const today = new Date();
  const year = today.getFullYear();
  const month = today.getMonth();
  const day = today.getDate();
  let workingDays = 0;
  for (let d = 1; d <= day; d++) {
    const dt = new Date(year, month, d);
    if (dt.getDay() !== 0) workingDays++;
  }
  return Math.max(1, workingDays);
}
function countRemainingWorkingDays() {
  const today = new Date();
  const year = today.getFullYear();
  const month = today.getMonth();
  const lastDay = new Date(year, month+1, 0).getDate();
  let rem = 0;
  for (let d = today.getDate()+1; d <= lastDay; d++) {
    const dt = new Date(year, month, d);
    if (dt.getDay() !== 0) rem++;
  }
  return rem;
}
function countWorkingDaysTotal() {
  const today = new Date();
  const year = today.getFullYear();
  const month = today.getMonth();
  const lastDay = new Date(year, month+1, 0).getDate();
  let total = 0;
  for (let d = 1; d <= lastDay; d++) {
    const dt = new Date(year, month, d);
    if (dt.getDay() !== 0) total++;
  }
  return Math.max(1, total);
}

/* Run Rate & Trending */
function updateRunRatesAndTrending(tPh,aPh,tPl,aPl){
  const W_passed = countWorkingDaysTillToday();
  const W_remaining = countRemainingWorkingDays();
  const W_total = countWorkingDaysTotal();

  // Pharma
  const pharmaCRR = Math.round(aPh / Math.max(1, W_passed));
  const pharmaGap = Math.max(0, tPh - aPh);
  const pharmaRRR = W_remaining > 0 ? Math.ceil(pharmaGap / Math.max(1, W_remaining)) : pharmaGap;
  // Trending projection
  const pharmaProjected = Math.round((pharmaCRR) * W_total);
  const pharmaProjectedGap = Math.max(0, tPh - pharmaProjected);

  // PL
  const plCRR = Math.round(aPl / Math.max(1, W_passed));
  const plGap = Math.max(0, tPl - aPl);
  const plRRR = W_remaining > 0 ? Math.ceil(plGap / Math.max(1, W_remaining)) : plGap;
  const plProjected = Math.round((plCRR) * W_total);
  const plProjectedGap = Math.max(0, tPl - plProjected);

  // Write to DOM
  document.getElementById("pharmaCRR").textContent = pharmaCRR === 0 ? "-" : fmtMoney(pharmaCRR);
  document.getElementById("pharmaRRR").textContent = fmtMoney(pharmaRRR);
  document.getElementById("plCRR").textContent = plCRR === 0 ? "-" : fmtMoney(plCRR);
  document.getElementById("plRRR").textContent = fmtMoney(plRRR);

  document.getElementById("trend_pharma_crr").textContent = pharmaCRR===0? "-" : fmtMoney(pharmaCRR);
  document.getElementById("trend_pharma_projected").textContent = fmtMoney(pharmaProjected);
  document.getElementById("trend_pharma_gap").textContent = fmtMoney(pharmaProjectedGap);

  document.getElementById("trend_pl_crr").textContent = plCRR===0? "-" : fmtMoney(plCRR);
  document.getElementById("trend_pl_projected").textContent = fmtMoney(plProjected);
  document.getElementById("trend_pl_gap").textContent = fmtMoney(plProjectedGap);
}

/* Google Charts */
google.charts.load("current",{packages:["corechart","bar"]});

/* Apps Script API URL */
const API_URL = "https://script.google.com/macros/s/AKfycbwHPdcB4MLaKu3VUDNfpkpiWEvnz3nRhwbbna0-5dn0dlO-ICf6913k8n9yMScc3fO8/exec";

/* Auth state */
auth.onAuthStateChanged(user=>{
  if(user){
    document.getElementById("loginBtn").style.display="none";
    document.getElementById("logoutBtn").style.display="inline-block";
    // show email while loading; we'll replace with name after data loaded
    document.getElementById("userInfo").textContent = user.email;
    loadSalesAndAll(user.email);
  } else {
    document.getElementById("loginBtn").style.display="inline-block";
    document.getElementById("logoutBtn").style.display="none";
    document.getElementById("userInfo").textContent="Please login to view sales";
    // reset UI
    clearUI();
  }
});

document.getElementById("loginBtn").onclick = ()=>{
  const provider=new firebase.auth.GoogleAuthProvider();
  auth.signInWithPopup(provider).catch(e=>console.error("Login error",e));
};
document.getElementById("logoutBtn").onclick = ()=>auth.signOut();

/* Clear UI helper */
function clearUI(){
  ["targetPharma","pharmaSales","pendingPharma","achievedPharmaPercent",
   "targetPL","plSales","pendingPL","achievedPLPercent",
   "pharmaCRR","pharmaRRR","plCRR","plRRR",
   "trend_pharma_crr","trend_pharma_projected","trend_pharma_gap",
   "trend_pl_crr","trend_pl_projected","trend_pl_gap",
   "rankValue"].forEach(id=>{
     const el = document.getElementById(id);
     if (el) el.textContent = "-";
  });
  const chart = document.getElementById("chart_bar");
  if (chart) chart.innerHTML = "";
}

/* Load single salesman and all to compute rank */
async function loadSalesAndAll(email){
  try {
    // fetch current user row
    const res = await fetch(API_URL + "?email=" + encodeURIComponent(email));
    const data = await res.json();
    if(!data || !data.length){
      // no data for this user
      alert("No sales data found for this user email in sheet.");
      return;
    }
    const row = data[0];

    const targetPharma = safeNum(row.targetPharma);
    const pharmaSales = safeNum(row.pharmaSales);
    const pendingPharma = safeNum(row.pendingPharma);
    const targetPL = safeNum(row.targetPL);
    const plSales = safeNum(row.plSales);
    const pendingPL = safeNum(row.pendingPL);

    // show name (if available) else email
    const nameToShow = (row.salesmanName && row.salesmanName.trim()) ? row.salesmanName.trim() : firebase.auth().currentUser.email;
    document.getElementById("userInfo").textContent = nameToShow;

    // set KPI values
    document.getElementById("targetPharma").textContent=fmtMoney(targetPharma);
    document.getElementById("pharmaSales").textContent=fmtMoney(pharmaSales);
    document.getElementById("pendingPharma").textContent=fmtMoney(pendingPharma);
    document.getElementById("achievedPharmaPercent").textContent=fmtPercentValue(row.achievedPharmaPercent);

    document.getElementById("targetPL").textContent=fmtMoney(targetPL);
    document.getElementById("plSales").textContent=fmtMoney(plSales);
    document.getElementById("pendingPL").textContent=fmtMoney(pendingPL);
    document.getElementById("achievedPLPercent").textContent=fmtPercentValue(row.achievedPLPercent);

    // run rate & trending
    updateRunRatesAndTrending(targetPharma, pharmaSales, targetPL, plSales);

    // draw chart
    drawBarChart(targetPharma, pharmaSales, targetPL, plSales);

    // compute rank: try to fetch full list from API using a query param all=true
    computeRank(email);

  } catch (err) {
    console.error("Load error", err);
  }
}

/* Compute rank by fetching all sales rows (API must support ?all=true) */
async function computeRank(currentEmail){
  try {
    const resAll = await fetch(API_URL + "?all=true");
    const all = await resAll.json();

    if(!all || !all.length){
      // fallback: show dash
      document.getElementById("rankValue").textContent = "-";
      return;
    }

    // compute score: sum of pharma% and pl% (normalize if decimals)
    const scores = all.map(r=>{
      const p = Number(String(r.achievedPharmaPercent).replace(/,/g,"")) || 0;
      const l = Number(String(r.achievedPLPercent).replace(/,/g,"")) || 0;
      // if decimals (<=1) convert to percent*100
      const pNorm = (p > 0 && p <= 1) ? p*100 : p;
      const lNorm = (l > 0 && l <= 1) ? l*100 : l;
      const total = pNorm + lNorm;
      return { email: (r.email||"").toLowerCase().trim(), total };
    });

    // sort descending by total
    scores.sort((a,b)=>b.total - a.total);

    // find rank (1-based)
    const idx = scores.findIndex(s => s.email === (currentEmail||"").toLowerCase().trim());
    if(idx === -1){
      document.getElementById("rankValue").textContent = "-";
    } else {
      document.getElementById("rankValue").textContent = (idx+1);
    }

  } catch(e){
    console.error("Rank calc error", e);
    document.getElementById("rankValue").textContent = "-";
  }
}

/* drawBarChart: Achieved = vertical bars, Target = horizontal line with markers */
function drawBarChart(tPh, aPh, tPl, aPl) {
  const data = google.visualization.arrayToDataTable([
    ["Category", "Achieved", "Target"],
    ["Pharma", aPh, tPh],
    ["PL", aPl, tPl]
  ]);

  const options = {
    chartArea: { width: "70%", height: "75%" },
    seriesType: "bars",
    series: {
      1: {
        type: "line",
        color: "#f6c000",
        lineWidth: 3,
        pointSize: 7,
        visibleInLegend: true
      }
    },
    colors: ["#16a34a", "#f6c000"],
    vAxis: { minValue: 0, format: 'short' },
    legend: { position: 'right', alignment: 'center' }
  };

  const chart = new google.visualization.ComboChart(document.getElementById("chart_bar"));
  chart.draw(data, options);
}

/* If window resizes, redraw chart for responsiveness */
window.addEventListener('resize', ()=> {
  // trigger redraw by re-fetching values from DOM
  const tPh = safeNum(document.getElementById("targetPharma").textContent);
  const aPh = safeNum(document.getElementById("pharmaSales").textContent);
  const tPl = safeNum(document.getElementById("targetPL").textContent);
  const aPl = safeNum(document.getElementById("plSales").textContent);
  try { drawBarChart(tPh,aPh,tPl,aPl); } catch(e){/*ignore*/ }
});
</script>

</body>
</html>


<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Sales Dashboard</title>

  <!-- Firebase v8 (Browser) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

  <!-- Google Charts -->
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <style>
    :root{
      --bg:#f6f7fb; --card:#ffffff;
      --accent:#f6c000; --accent-dark:#e0ad00;
      --green:#8bc34a; --red:#e53935; --muted:#6b7280;
      --primary:#1e3a8a;
      --radius:12px;
    }
    body{font-family:Inter, Arial, sans-serif; margin:0; padding:18px; background:var(--bg); color:#0f172a;}
    .container{max-width:1100px; margin:0 auto;}
    header{display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:18px}
    h1{margin:0; font-size:26px; color:var(--primary)}
    .top-actions{display:flex; gap:10px}
    button.btn{background:var(--primary); color:#fff; border:none; padding:8px 12px; border-radius:8px; cursor:pointer}
    button.btn.secondary{background:#fff; color:var(--primary); border:1px solid #d1d5db}
    .profile{font-size:14px; color:var(--muted)}
    .grid{display:grid; grid-template-columns: repeat(12, 1fr); gap:14px;}
    .card{background:var(--card); border-radius:var(--radius); padding:14px; box-shadow:0 6px 18px rgba(15,23,42,0.06)}
    .section-title{font-weight:700; font-size:15px; color:var(--primary); margin-bottom:8px}
    .kpi {display:flex; gap:12px; align-items:center}
    .kpi .tile{flex:1; padding:12px; border-radius:10px; background:#ffffff; text-align:center; border:1px solid #e5e7eb}
    .kpi .tile h4{margin:0; font-size:12px; color:var(--muted)}
    .kpi .tile p{margin:6px 0 0; font-weight:700; font-size:17px}
    .left-col{grid-column:span 8}
    .right-col{grid-column:span 4}
    #chart_bar,#chart_donut{width:100%; height:300px}
    .row-flex{display:flex; gap:10px; flex-wrap:wrap}
    .half{flex:1; min-width:130px}
    .small-box{padding:12px; border-radius:10px; border:1px solid #e5e7eb; background:#fff}
    .small-value{font-size:18px; font-weight:700}
    .label-muted{color:var(--muted); font-size:12px}
    @media (max-width:880px){
      .left-col{grid-column:span 12}
      .right-col{grid-column:span 12}
      #chart_bar,#chart_donut{height:240px}
      header{flex-direction:column; align-items:flex-start}
    }
  </style>
</head>
<body>

  <div class="container">

    <!-- Top -->
    <header>
      <div>
        <h1>Your Sales Performance Report <span id="reportDate" style="font-size:13px;color:var(--muted)"></span></h1>
        <div id="userInfo" class="profile">Please login to view sales</div>
      </div>

      <div class="top-actions">
        <button id="loginBtn" class="btn">Login with Google</button>
        <button id="logoutBtn" class="btn secondary" style="display:none">Logout</button>
      </div>
    </header>

    <!-- GRID -->
    <div class="grid">

      <!-- LEFT -->
      <div class="card left-col">

        <div class="section-title">Pharma Performance</div>
        <div class="kpi" style="margin-bottom:12px">
          <div class="tile">
            <h4>Target Pharma</h4>
            <p id="targetPharma">-</p>
          </div>
          <div class="tile">
            <h4>Achieved Pharma</h4>
            <p id="pharmaSales">-</p>
          </div>
          <div class="tile">
            <h4>Pending Pharma</h4>
            <p id="pendingPharma">-</p>
          </div>
          <div class="tile">
            <h4>Pharma %</h4>
            <p id="achievedPharmaPercent">-</p>
          </div>
        </div>

        <!-- Pharma Run Rate Section -->
        <div class="section-title">Pharma Run Rate</div>
        <div class="row-flex" style="margin-bottom:12px">
          <div class="half small-box">
            <div class="label-muted">Daily Pharma Average (CRR)</div>
            <div class="small-value" id="pharmaCRR">-</div>
            <div class="label-muted">/day</div>
          </div>
          <div class="half small-box">
            <div class="label-muted">Daily Pharma Needed (RRR)</div>
            <div class="small-value" id="pharmaRRR">-</div>
            <div class="label-muted">/day</div>
          </div>
        </div>

        <!-- PL -->
        <div class="section-title">PL Performance</div>
        <div class="kpi" style="margin-bottom:12px">
          <div class="tile">
            <h4>Target PL</h4>
            <p id="targetPL">-</p>
          </div>
          <div class="tile">
            <h4>Achieved PL</h4>
            <p id="plSales">-</p>
          </div>
          <div class="tile">
            <h4>Pending PL</h4>
            <p id="pendingPL">-</p>
          </div>
          <div class="tile">
            <h4>PL %</h4>
            <p id="achievedPLPercent">-</p>
          </div>
        </div>

        <!-- PL Run Rate -->
        <div class="section-title">PL Run Rate</div>
        <div class="row-flex" style="margin-bottom:12px">
          <div class="half small-box">
            <div class="label-muted">Daily PL Average (CRR)</div>
            <div class="small-value" id="plCRR">-</div>
            <div class="label-muted">/day</div>
          </div>
          <div class="half small-box">
            <div class="label-muted">Daily PL Needed (RRR)</div>
            <div class="small-value" id="plRRR">-</div>
            <div class="label-muted">/day</div>
          </div>
        </div>

        <div class="section-title">Target vs Achievement</div>
        <div id="chart_bar"></div>
      </div>

      <!-- RIGHT -->
      <div class="card right-col">
        <div class="section-title">Summary Overview</div>
        <div id="chart_donut"></div>
      </div>

    </div>

  </div>

<!-- SCRIPT -->
<script>
/* Firebase */
const firebaseConfig = {
  apiKey: "AIzaSyAtdeN84prygknfyF-aZ7d6Wr0m2LYSFek",
  authDomain: "salesdashboard-8a33e.firebaseapp.com",
  projectId: "salesdashboard-8a33e",
  storageBucket: "salesdashboard-8a33e.firebasestorage.app",
  messagingSenderId: "939228252310",
  appId: "1:939228252310:web:c847ef8b0afc92e7495ab7"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();

document.getElementById("reportDate").textContent =
  new Date().toLocaleDateString("en-IN");

/* Helpers */
function safeNum(v){
  if (v === undefined || v === null || v === "") return 0;
  v = (v+"").replace(/,/g,"").trim();
  return Number(v) || 0;
}
function fmtMoney(n){
  return new Intl.NumberFormat("en-IN").format(n);
}

/* Working days */
function countWorkingDaysTillToday() {
  const today = new Date();
  const y = today.getFullYear();
  const m = today.getMonth();
  const d = today.getDate();
  let wd = 0;
  for (let i=1;i<=d;i++){
    const dt = new Date(y,m,i);
    if (dt.getDay() !== 0) wd++;  // exclude Sundays
  }
  return Math.max(1, wd);
}
function countRemainingWorkingDays() {
  const today = new Date();
  const y = today.getFullYear();
  const m = today.getMonth();
  const start = today.getDate()+1;
  const last = new Date(y,m+1,0).getDate();
  let rem = 0;
  for (let i=start;i<=last;i++){
    const dt = new Date(y,m,i);
    if (dt.getDay() !== 0) rem++;
  }
  return rem;
}

/* Run Rate */
function updateRunRates(tPh,aPh,tPl,aPl){
  const Wp = countWorkingDaysTillToday();
  const Wr = countRemainingWorkingDays();

  const phCRR = Math.round(aPh / Wp);
  const phGap = Math.max(0, tPh - aPh);
  const phRRR = Wr>0 ? Math.ceil(phGap / Wr) : phGap;

  const plCRR = Math.round(aPl / Wp);
  const plGap = Math.max(0, tPl - aPl);
  const plRRR = Wr>0 ? Math.ceil(plGap / Wr) : plGap;

  document.getElementById("pharmaCRR").textContent = phCRR === 0 ? "-" : fmtMoney(phCRR);
  document.getElementById("pharmaRRR").textContent = fmtMoney(phRRR);
  document.getElementById("plCRR").textContent = plCRR === 0 ? "-" : fmtMoney(plCRR);
  document.getElementById("plRRR").textContent = fmtMoney(plRRR);
}

/* Google Charts */
google.charts.load("current",{packages:["corechart","bar"]});

/* Fetch & Load */
const API_URL = "https://script.google.com/macros/s/AKfycbwHPdcB4MLaKu3VUDNfpkpiWEvnz3nRhwbbna0-5dn0dlO-ICf6913k8n9yMScc3fO8/exec";

auth.onAuthStateChanged(user=>{
  if(user){
    document.getElementById("loginBtn").style.display="none";
    document.getElementById("logoutBtn").style.display="inline-block";
    document.getElementById("userInfo").textContent=user.email;
    loadSales(user.email);
  } else {
    document.getElementById("loginBtn").style.display="inline-block";
    document.getElementById("logoutBtn").style.display="none";
    document.getElementById("userInfo").textContent="Please login to view sales";
  }
});

document.getElementById("loginBtn").onclick = ()=>{
  const provider=new firebase.auth.GoogleAuthProvider();
  auth.signInWithPopup(provider);
};
document.getElementById("logoutBtn").onclick = ()=>auth.signOut();

async function loadSales(email){
  const res = await fetch(API_URL + "?email=" + encodeURIComponent(email));
  const data = await res.json();
  if(!data || !data.length) return;

  const row = data[0];

  const targetPharma = safeNum(row.targetPharma);
  const pharmaSales = safeNum(row.pharmaSales);
  const pendingPharma = safeNum(row.pendingPharma);
  const targetPL = safeNum(row.targetPL);
  const plSales = safeNum(row.plSales);
  const pendingPL = safeNum(row.pendingPL);

  document.getElementById("targetPharma").textContent=fmtMoney(targetPharma);
  document.getElementById("pharmaSales").textContent=fmtMoney(pharmaSales);
  document.getElementById("pendingPharma").textContent=fmtMoney(pendingPharma);
  document.getElementById("achievedPharmaPercent").textContent=row.achievedPharmaPercent;

  document.getElementById("targetPL").textContent=fmtMoney(targetPL);
  document.getElementById("plSales").textContent=fmtMoney(plSales);
  document.getElementById("pendingPL").textContent=fmtMoney(pendingPL);
  document.getElementById("achievedPLPercent").textContent=row.achievedPLPercent;

  /* Run rate update */
  updateRunRates(targetPharma,pharmaSales,targetPL,plSales);

  drawBarChart(targetPharma,pharmaSales,targetPL,plSales);
  drawDonutChart(pharmaSales,plSales,pendingPharma,pendingPL);
}

function drawBarChart(tPh,aPh,tPl,aPl){
  const data = google.visualization.arrayToDataTable([
    ["Category","Target","Achieved"],
    ["Pharma", tPh, aPh],
    ["PL", tPl, aPl]
  ]);
  const opt={
    chartArea:{width:"70%"},
    colors:["#f6c000","#16a34a"],
    hAxis:{minValue:0}
  };
  const chart=new google.visualization.ColumnChart(document.getElementById("chart_bar"));
  chart.draw(data,opt);
}

function drawDonutChart(aPh,aPl,pPh,pPl){
  const d=google.visualization.arrayToDataTable([
    ["Type","Value"],
    ["Pharma Sales", Math.max(0,aPh)],
    ["PL Sales", Math.max(0,aPl)],
    ["Pending Pharma", Math.max(0,pPh)],
    ["Pending PL", Math.max(0,pPl)]
  ]);
  const opt={pieHole:0.45, chartArea:{width:"90%",height:"80%"}, colors:["#2563eb","#38bdf8","#fb7185","#fda4af"]};
  const ch=new google.visualization.PieChart(document.getElementById("chart_donut"));
  ch.draw(d,opt);
}
</script>

</body>
</html>

